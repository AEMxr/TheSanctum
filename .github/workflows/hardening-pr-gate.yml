name: hardening-pr-gate

on:
  pull_request:
    branches:
      - main
    types:
      - opened
      - edited
      - synchronize
      - reopened
      - ready_for_review

permissions:
  contents: read
  pull-requests: read

jobs:
  enforce-hardening-gate:
    runs-on: ubuntu-latest
    if: ${{ github.event.pull_request.draft == false }}
    steps:
      - name: Validate hardening PR contract
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || "";
            const headRef = pr.head.ref || "";
            const errors = [];

            if (!/^hardening\/.+/.test(headRef)) {
              errors.push(`Head branch must match hardening/* (actual: ${headRef || "(empty)"}).`);
            }

            const requiredCheckedPatterns = [
              {
                label: "Branch classification checkbox",
                pattern: /- \[[xX]\]\s+Branch name uses `hardening\/\*`/
              },
              {
                label: "Boundary checkbox: delivery_mode=tenant_only",
                pattern: /- \[[xX]\]\s+`delivery_mode=tenant_only` verified/
              },
              {
                label: "Boundary checkbox: cross_sell_allowed=false",
                pattern: /- \[[xX]\]\s+`cross_sell_allowed=false` verified/
              },
              {
                label: "Test gate checkbox: language integration",
                pattern: /- \[[xX]\]\s+`tests\/integration\/language_api\.http\.Tests\.ps1`/
              },
              {
                label: "Test gate checkbox: revenue integration",
                pattern: /- \[[xX]\]\s+`tests\/integration\/revenue_api\.http\.Tests\.ps1`/
              },
              {
                label: "Test gate checkbox: both APIs smoke",
                pattern: /- \[[xX]\]\s+`tests\/both_apis\.smoke\.Tests\.ps1`/
              },
              {
                label: "Artifact checkbox: language ready payload",
                pattern: /- \[[xX]\]\s+Ready payload \(language\):\s+`artifacts\/runtime\/language_ready\.pilot\.json`/
              },
              {
                label: "Artifact checkbox: revenue ready payload",
                pattern: /- \[[xX]\]\s+Ready payload \(revenue\):\s+`artifacts\/runtime\/revenue_ready\.pilot\.json`/
              },
              {
                label: "Artifact checkbox: smoke summary",
                pattern: /- \[[xX]\]\s+Smoke summary:\s+`artifacts\/runtime\/both_apis_smoke\.summary\.postmerge\.json`/
              },
              {
                label: "Artifact checkbox: commit fingerprint",
                pattern: /- \[[xX]\]\s+Commit fingerprint:\s+`artifacts\/runtime\/pilot_commit_[^`]+\.txt`/
              }
            ];

            for (const check of requiredCheckedPatterns) {
              if (!check.pattern.test(body)) {
                errors.push(`Missing checked item: ${check.label}.`);
              }
            }

            const requiredArtifactPaths = [
              "artifacts/runtime/language_ready.pilot.json",
              "artifacts/runtime/revenue_ready.pilot.json",
              "artifacts/runtime/both_apis_smoke.summary.postmerge.json"
            ];

            for (const path of requiredArtifactPaths) {
              if (!body.includes(path)) {
                errors.push(`Required artifact path not found in PR body: ${path}.`);
              }
            }

            if (errors.length > 0) {
              core.setFailed(`Hardening PR gate failed:\n- ${errors.join("\n- ")}`);
              return;
            }

            core.info("Hardening PR gate checks passed.");

